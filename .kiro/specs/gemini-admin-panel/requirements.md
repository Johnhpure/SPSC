# Gemini API 管理后台需求文档

## 简介

本文档定义了为后端服务开发 Gemini API 管理后台的需求。该管理后台允许用户通过 Web 界面管理 Gemini API 配置、监控 API 使用情况、测试模型性能，并查看完整的调用日志。这将为运维人员和开发者提供一个集中化的管理工具，提升 API 配置的灵活性和可观测性。

## 术语表

- **管理后台 (Admin Panel)**: 用于管理 Gemini API 配置和监控的 Web 界面
- **API Base URL**: Gemini API 的基础 URL 地址，可自定义以支持不同的 API 端点或代理
- **API Key**: 用于认证 Gemini API 请求的密钥，支持配置多个密钥实现负载均衡或故障转移
- **模型列表 (Model List)**: 从 Gemini API 获取的可用模型清单
- **模型测速 (Model Benchmark)**: 测试特定模型的响应时间和性能指标
- **调用日志 (Call Log)**: 记录每次 API 调用的详细信息，包括请求参数、响应数据、耗时等
- **日志持久化 (Log Persistence)**: 将调用日志保存到数据库或文件系统以供后续查询和分析

## 需求

### 需求 1：API Base URL 配置管理

**用户故事**: 作为系统管理员，我希望能够自定义 Gemini API 的 Base URL，以便支持不同的 API 端点、代理服务器或内网部署。

#### 验收标准

1. WHEN 管理员访问配置页面时 THEN 系统应显示当前配置的 API Base URL
2. WHEN 管理员输入新的 Base URL 时 THEN 系统应验证 URL 格式的有效性
3. WHEN 保存 Base URL 配置时 THEN 系统应将配置持久化到数据库
4. WHEN Base URL 更新后 THEN 系统应使用新的 URL 进行后续的 API 调用
5. WHEN Base URL 格式无效时 THEN 系统应显示明确的错误提示并阻止保存

### 需求 2：API Key 批量管理

**用户故事**: 作为系统管理员，我希望能够添加、编辑和删除多个 API Key，以便实现负载均衡、故障转移或不同环境的密钥隔离。

#### 验收标准

1. WHEN 管理员访问 API Key 管理页面时 THEN 系统应显示所有已配置的 API Key 列表
2. WHEN 管理员添加新的 API Key 时 THEN 系统应支持一次性输入多个密钥（换行或逗号分隔）
3. WHEN 保存 API Key 时 THEN 系统应对每个密钥进行格式验证
4. WHEN 显示 API Key 时 THEN 系统应对密钥进行脱敏显示（仅显示前后几位字符）
5. WHEN 删除 API Key 时 THEN 系统应要求确认并从数据库中移除该密钥
6. WHEN 编辑 API Key 时 THEN 系统应允许修改密钥的备注名称或启用状态
7. WHEN 存在多个 API Key 时 THEN 系统应支持设置密钥的优先级或轮询策略

### 需求 3：模型列表获取与选择

**用户故事**: 作为系统管理员，我希望能够从 API Base URL 获取最新的可用模型列表，并选择要使用的模型，以便确保系统使用最合适的模型版本。

#### 验收标准

1. WHEN 管理员点击"获取模型列表"按钮时 THEN 系统应从配置的 API Base URL 请求可用模型列表
2. WHEN 模型列表获取成功时 THEN 系统应显示所有可用模型及其基本信息（名称、描述、能力）
3. WHEN 模型列表获取失败时 THEN 系统应显示错误信息并提供重试选项
4. WHEN 管理员选择模型时 THEN 系统应允许为不同的服务类型（文本生成、图像分析、图像生成）配置不同的默认模型
5. WHEN 保存模型配置时 THEN 系统应将选择的模型持久化到数据库
6. WHEN 模型配置更新后 THEN 系统应在后续的 API 调用中使用新配置的模型

### 需求 4：模型性能测速

**用户故事**: 作为系统管理员，我希望能够测试不同模型的响应速度和性能，以便选择最适合当前业务需求的模型。

#### 验收标准

1. WHEN 管理员选择一个模型进行测速时 THEN 系统应使用标准测试提示词向该模型发送请求
2. WHEN 测速请求发送时 THEN 系统应记录请求开始时间
3. WHEN 测速请求完成时 THEN 系统应计算并显示响应时间、token 生成速率等性能指标
4. WHEN 测速失败时 THEN 系统应显示失败原因和错误详情
5. WHEN 进行批量测速时 THEN 系统应支持同时测试多个模型并生成对比报告
6. WHEN 测速完成时 THEN 系统应将测速结果保存到数据库以供历史对比

### 需求 5：模型功能测试

**用户故事**: 作为系统管理员，我希望能够测试模型的实际功能表现，以便验证模型是否满足业务需求。

#### 验收标准

1. WHEN 管理员选择一个模型进行功能测试时 THEN 系统应提供自定义提示词输入框
2. WHEN 管理员输入测试提示词并提交时 THEN 系统应调用选定的模型并返回生成结果
3. WHEN 测试文本生成模型时 THEN 系统应显示生成的文本内容和相关元数据
4. WHEN 测试图像分析模型时 THEN 系统应支持上传测试图像并显示分析结果
5. WHEN 测试图像生成模型时 THEN 系统应显示生成的图像和相关参数
6. WHEN 测试失败时 THEN 系统应显示详细的错误信息和调试建议

### 需求 6：API 调用日志全记录

**用户故事**: 作为系统管理员，我希望系统能够记录所有 Gemini API 调用的详细信息，以便进行审计、调试和性能分析。

#### 验收标准

1. WHEN 系统调用 Gemini API 时 THEN 系统应记录请求的时间戳、模型名称、请求参数
2. WHEN API 响应返回时 THEN 系统应记录响应时间、状态码、token 使用量、响应内容摘要
3. WHEN API 调用失败时 THEN 系统应记录错误类型、错误消息和堆栈跟踪
4. WHEN 记录日志时 THEN 系统应为每条日志生成唯一标识符以便追踪
5. WHEN 日志包含敏感信息时 THEN 系统应对 API Key 等敏感字段进行脱敏处理
6. WHEN 日志量较大时 THEN 系统应实施日志轮转或归档策略以控制存储空间

### 需求 7：日志查询与过滤

**用户故事**: 作为系统管理员，我希望能够查询和过滤历史调用日志，以便快速定位问题或分析使用模式。

#### 验收标准

1. WHEN 管理员访问日志页面时 THEN 系统应显示最近的 API 调用日志列表
2. WHEN 管理员设置时间范围过滤时 THEN 系统应仅显示指定时间段内的日志
3. WHEN 管理员按模型名称过滤时 THEN 系统应仅显示使用该模型的调用日志
4. WHEN 管理员按状态过滤时 THEN 系统应支持筛选成功、失败或特定错误类型的日志
5. WHEN 管理员搜索关键词时 THEN 系统应在请求参数和响应内容中进行全文搜索
6. WHEN 日志数量较多时 THEN 系统应支持分页显示并提供页码导航

### 需求 8：日志详情查看

**用户故事**: 作为系统管理员，我希望能够查看单条日志的完整详情，以便深入了解特定 API 调用的所有信息。

#### 验收标准

1. WHEN 管理员点击某条日志时 THEN 系统应显示该日志的完整详情页面
2. WHEN 显示日志详情时 THEN 系统应展示请求的完整参数（格式化的 JSON）
3. WHEN 显示日志详情时 THEN 系统应展示响应的完整内容（格式化的 JSON 或文本）
4. WHEN 显示日志详情时 THEN 系统应展示性能指标（响应时间、token 使用量等）
5. WHEN 日志包含错误时 THEN 系统应高亮显示错误信息和堆栈跟踪
6. WHEN 查看日志详情时 THEN 系统应提供"复制"或"导出"功能以便分享或存档

### 需求 9：日志导出与下载

**用户故事**: 作为系统管理员，我希望能够导出和下载日志数据，以便进行离线分析或长期归档。

#### 验收标准

1. WHEN 管理员选择导出日志时 THEN 系统应支持导出为 JSON、CSV 或 Excel 格式
2. WHEN 导出日志时 THEN 系统应允许选择导出的时间范围和过滤条件
3. WHEN 导出大量日志时 THEN 系统应在后台处理并提供下载链接
4. WHEN 导出完成时 THEN 系统应通知管理员并提供下载按钮
5. WHEN 下载日志文件时 THEN 系统应确保文件包含所有选定的日志记录和字段

### 需求 10：统计与可视化

**用户故事**: 作为系统管理员，我希望能够查看 API 使用的统计数据和可视化图表，以便了解系统的整体运行状况。

#### 验收标准

1. WHEN 管理员访问统计页面时 THEN 系统应显示总调用次数、成功率、失败率等关键指标
2. WHEN 显示统计数据时 THEN 系统应提供时间维度的趋势图（按小时、天、周、月）
3. WHEN 分析模型使用时 THEN 系统应显示各模型的调用次数和占比（饼图或柱状图）
4. WHEN 分析性能时 THEN 系统应显示平均响应时间、P95、P99 等性能指标
5. WHEN 分析成本时 THEN 系统应显示 token 使用量和预估成本
6. WHEN 统计数据更新时 THEN 系统应支持实时或定期刷新统计数据

### 需求 11：配置备份与恢复

**用户故事**: 作为系统管理员，我希望能够备份和恢复 API 配置，以便在配置错误或系统迁移时快速恢复。

#### 验收标准

1. WHEN 管理员点击"备份配置"时 THEN 系统应导出当前所有配置为 JSON 文件
2. WHEN 备份配置时 THEN 系统应包含 Base URL、API Keys、模型选择等所有配置项
3. WHEN 管理员上传备份文件时 THEN 系统应验证文件格式和内容的有效性
4. WHEN 恢复配置时 THEN 系统应提示管理员确认并显示将要恢复的配置内容
5. WHEN 恢复完成时 THEN 系统应应用新配置并重新初始化 API 客户端

### 需求 12：权限控制与安全

**用户故事**: 作为系统管理员，我希望管理后台具有适当的权限控制，以便保护敏感配置和数据。

#### 验收标准

1. WHEN 用户访问管理后台时 THEN 系统应要求身份验证
2. WHEN 用户未登录时 THEN 系统应重定向到登录页面
3. WHEN 用户权限不足时 THEN 系统应拒绝访问敏感操作（如删除 API Key、修改配置）
4. WHEN 记录操作日志时 THEN 系统应记录操作用户、操作类型和操作时间
5. WHEN 显示敏感信息时 THEN 系统应对 API Key 等信息进行脱敏处理
