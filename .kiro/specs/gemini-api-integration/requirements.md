# Gemini API 完整集成需求文档

## 简介

本文档定义了将 Google Gemini API 完整集成到后端服务的需求。当前系统使用旧版 SDK 和过时的模型，且缺少关键功能如图像生成、多模态输入、文件上传等。本次集成将升级到最新的统一 SDK，并实现完整的 AI 功能支持。

## 术语表

- **Gemini API**: Google 的生成式 AI API，支持文本生成、图像分析、图像生成等多模态功能
- **GoogleGenAI Client**: 新版统一 SDK 的客户端类，用于初始化和管理 API 连接
- **多模态内容 (Multimodal Content)**: 包含文本、图像、视频等多种类型数据的内容
- **流式响应 (Streaming Response)**: 实时逐块返回生成内容的响应方式
- **Files API**: Gemini API 的文件管理接口，用于上传和管理大文件
- **Part**: 内容的组成部分，可以是文本、图像数据或文件引用
- **Content**: 由多个 Part 组成的完整内容对象

## 需求

### 需求 1：SDK 升级和客户端初始化

**用户故事**: 作为开发者，我希望使用最新的 Gemini SDK，以便获得最新功能和最佳性能。

#### 验收标准

1. WHEN 系统启动时 THEN 系统应使用 @google/genai 包（而非旧版 @google/generative-ai）初始化 GoogleGenAI 客户端
2. WHEN 初始化客户端时 THEN 系统应从环境变量读取 API 密钥并进行验证
3. WHEN API 密钥无效或缺失时 THEN 系统应记录错误并提供清晰的错误消息
4. WHEN 客户端初始化成功时 THEN 系统应提供单例实例供所有服务使用
5. WHEN 系统运行在 MOCK_MODE 时 THEN 系统应跳过真实 API 调用并返回模拟数据

### 需求 2：文本生成服务

**用户故事**: 作为系统，我需要使用最新的 Gemini 模型生成文本内容，以便提供准确的类目推荐和产品分析。

#### 验收标准

1. WHEN 调用文本生成服务时 THEN 系统应使用 gemini-2.0-flash 或更新的模型（而非过时的 gemini-pro）
2. WHEN 生成类目推荐时 THEN 系统应接收产品标题和描述作为输入
3. WHEN 生成内容时 THEN 系统应支持配置参数如 maxOutputTokens、temperature 等
4. WHEN API 调用失败时 THEN 系统应捕获错误、记录日志并返回降级响应
5. WHEN 响应包含结构化数据时 THEN 系统应正确解析并验证输出格式

### 需求 3：图像分析服务（多模态输入）

**用户故事**: 作为系统，我需要分析产品图像以提取信息和生成优化建议，以便改善产品展示质量。

#### 验收标准

1. WHEN 分析产品图像时 THEN 系统应支持通过 URL 或本地文件路径输入图像
2. WHEN 处理图像 URL 时 THEN 系统应下载图像并转换为 base64 格式或上传到 Files API
3. WHEN 创建多模态请求时 THEN 系统应组合文本提示和图像数据为 Content 对象
4. WHEN 发送分析请求时 THEN 系统应使用支持视觉的模型（如 gemini-2.0-flash）
5. WHEN 接收响应时 THEN 系统应提取文本分析结果并返回结构化数据
6. WHEN 图像格式不支持时 THEN 系统应返回明确的错误消息

### 需求 4：图像生成服务

**用户故事**: 作为系统，我需要根据文本描述生成优化的产品图像，以便为商家提供 AI 增强的视觉内容。

#### 验收标准

1. WHEN 生成图像时 THEN 系统应使用 imagen-3.0-generate 或更新的图像生成模型
2. WHEN 接收生成请求时 THEN 系统应接受文本提示和可选的配置参数
3. WHEN 配置图像生成时 THEN 系统应支持设置图像数量、尺寸等参数
4. WHEN 生成完成时 THEN 系统应返回 base64 编码的图像数据
5. WHEN 需要保存图像时 THEN 系统应将生成的图像保存到 uploads 目录并返回 URL
6. WHEN 生成失败时 THEN 系统应记录失败原因并返回降级的占位符图像

### 需求 5：文件管理服务

**用户故事**: 作为系统，我需要上传和管理大文件到 Gemini Files API，以便高效处理大型图像和视频。

#### 验收标准

1. WHEN 上传文件时 THEN 系统应使用 Files API 的 upload 方法
2. WHEN 文件上传成功时 THEN 系统应返回文件 URI 和元数据
3. WHEN 需要列出文件时 THEN 系统应支持分页查询已上传的文件
4. WHEN 文件不再需要时 THEN 系统应提供删除文件的功能
5. WHEN 文件大小超过限制时 THEN 系统应返回明确的错误消息
6. WHEN 文件 MIME 类型不支持时 THEN 系统应在上传前验证并拒绝

### 需求 6：流式响应支持

**用户故事**: 作为系统，我需要支持流式生成内容，以便为用户提供实时反馈和更好的体验。

#### 验收标准

1. WHEN 调用流式生成时 THEN 系统应使用 generateContentStream 方法
2. WHEN 接收流式响应时 THEN 系统应逐块处理并返回内容
3. WHEN 集成到 Express API 时 THEN 系统应支持 Server-Sent Events (SSE) 或类似机制
4. WHEN 流式传输中断时 THEN 系统应优雅处理错误并通知客户端
5. WHEN 流式完成时 THEN 系统应发送完成信号并关闭连接

### 需求 7：错误处理和重试机制

**用户故事**: 作为系统，我需要健壮的错误处理和重试逻辑，以便在 API 故障时保持服务可用性。

#### 验收标准

1. WHEN API 返回 429 限流错误时 THEN 系统应实施指数退避重试策略
2. WHEN API 返回 5xx 服务器错误时 THEN 系统应最多重试 3 次
3. WHEN 所有重试失败时 THEN 系统应记录详细错误并返回降级响应
4. WHEN 网络超时时 THEN 系统应在 30 秒后取消请求并返回错误
5. WHEN 错误发生时 THEN 系统应记录请求参数、错误类型和堆栈跟踪以便调试

### 需求 8：配置和环境管理

**用户故事**: 作为运维人员，我需要灵活的配置选项，以便在不同环境中调整 API 行为。

#### 验收标准

1. WHEN 配置 API 时 THEN 系统应支持通过环境变量设置 API 密钥、模型名称、超时时间等
2. WHEN 在开发环境时 THEN 系统应支持 MOCK_MODE 以避免真实 API 调用
3. WHEN 切换模型时 THEN 系统应允许通过配置文件指定默认模型版本
4. WHEN 调整性能参数时 THEN 系统应支持配置并发限制、重试次数等
5. WHEN 配置更新时 THEN 系统应在不重启的情况下重新加载配置（热更新）

### 需求 9：日志和监控

**用户故事**: 作为运维人员，我需要详细的日志和监控指标，以便追踪 API 使用情况和诊断问题。

#### 验收标准

1. WHEN 调用 API 时 THEN 系统应记录请求参数、模型名称和时间戳
2. WHEN 接收响应时 THEN 系统应记录响应时间、token 使用量和状态码
3. WHEN 发生错误时 THEN 系统应记录完整的错误上下文和堆栈跟踪
4. WHEN 统计使用情况时 THEN 系统应提供 API 调用次数、成功率、平均响应时间等指标
5. WHEN 达到配额限制时 THEN 系统应发出警告并记录到监控系统

### 需求 10：测试和质量保证

**用户故事**: 作为开发者，我需要全面的测试覆盖，以便确保 API 集成的正确性和稳定性。

#### 验收标准

1. WHEN 运行单元测试时 THEN 系统应覆盖所有服务方法的正常流程
2. WHEN 测试错误场景时 THEN 系统应验证错误处理和降级逻辑
3. WHEN 使用 MOCK_MODE 时 THEN 系统应返回一致的模拟数据以支持测试
4. WHEN 集成测试时 THEN 系统应验证端到端的 API 调用流程
5. WHEN 性能测试时 THEN 系统应验证在高负载下的响应时间和稳定性
